## 虚拟机搭建外网访问网站

1. ip与防火墙设置
2. Apache搭建http网站
3. 内网穿透实现外网访问 (需要花费6元)



### ip与防火墙设置

先说明一下我的虚拟机环境

- CentOS7版本Linux系统
- 桥接模式下的网络
- 静态的IP地址

1. 首先在服务器终端下输入 `ifconfig` 查看IP地址

![image-20210531202557291](https://img2020.cnblogs.com/blog/2213660/202105/2213660-20210531202558071-1987890426.png) 

如果没有ifconfig，输入`yum search ifconfig` 进行查询服务，会得到

![img](https://www.linuxidc.com/upload/2018_10/181011090563194.png) 

即只需要安装 net-tools.x86_64 即可，输入 `yum install net-tools.x86_64 -y` 进行安装

2. CentOS7有一个自带的防火墙，叫做 **firewalld**，我们使用它进行防火墙配置，其他Linux系统可以下载这个来配置，也可以使用 **iptables** 

    - 输入 `firewall-cmd --list-services` 查看当前运行的服务，如果没有http服务则进行添加

        ![image-20210531203145622](https://img2020.cnblogs.com/blog/2213660/202105/2213660-20210531203145930-1733341036.png)  

    - 输入 `firewall-cmd --permanent --add-service=http` 添加http服务

        ![image-20210531203308061](https://img2020.cnblogs.com/blog/2213660/202105/2213660-20210531203308354-2133704672.png) 

    - 输入 `firewall-cmd --reload` 重载防火墙配置

        ![image-20210531203359180](https://img2020.cnblogs.com/blog/2213660/202105/2213660-20210531203359450-14038992.png) 

    - 然后再次查询当前运行的服务，这是http服务已经添加进来了

        ![a](https://img2020.cnblogs.com/blog/2213660/202105/2213660-20210531203445340-1098408934.png) 



### Apache搭建http网站

1. 安装Apache：

    ```bash
    yum -y install httpd
    ```

2. 安装完成后，会生成文件路径 `/var/www/html` ，这个是默认的web服务根目录

3. 运行服务

    ```bash
    /bin/systemctl start httpd.service
    ```

4. 这时在浏览器中输入上述的ip地址，就会出现一下页面

    ![image-20210531221858148](https://img2020.cnblogs.com/blog/2213660/202105/2213660-20210531221859491-741410725.png) 

    这表示内网网站已经构建成功

5. Apache的配置文件httpd.conf， 该文件在 `/etc/httpd/conf` 目录下，输入 `vi httpd.conf` 打开文件

    ![image-20210531222758313](https://img2020.cnblogs.com/blog/2213660/202105/2213660-20210531222759350-256603261.png) 

6. 输入 `/DirectoryIndex` 回车，查找到该内容

    ![image-20210531222933050](https://img2020.cnblogs.com/blog/2213660/202105/2213660-20210531222934139-1654045890.png) 

    表示网站主页面为上述根目录下的index.html，所以我们要构建自己的主页面，就需要将我们写好的html文件名**改为index.html**，或者将上述配置文件中的改为其他文件名

7. 输入 `/DocumentRoot` 回车，查找该内容

    ![image-20210531223740929](https://img2020.cnblogs.com/blog/2213660/202105/2213660-20210531223741830-543377208.png) 

    这个显示的就是网站的根目录，这个可以自行更改

8. 输入 `:q` 关闭文件

9. 切换到 `/var/www/html` 目录，这时该目录应该为空，我们可以添加一个index.html文件，内容自定义，如：

    ```html
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>index</title>
    </head>
    <body>
        <h1>
            Hello World！
        </h1>
    </body>
    </html>
    ```

    可以选择使用vi编辑器添加，也可以在宿主机上写好，然后文件传输

10. 这时，我们再在浏览器中输入ip地址，将显示自定义的网页

    ![image-20210531224530664](https://img2020.cnblogs.com/blog/2213660/202105/2213660-20210531224531526-517461952.png) 

**网站的基本配置就完成了** 



### 内网穿透实现外网访问网站

所需软件 **花生壳** 

先去官网：https://www.oray.com/ 注册一下账号

注册成功后会得到一个 **壳域名** 

然后转到 下载页面：https://hsk.oray.com/download 下载内网穿透的软件

选择Linux

![image-20210601100457653](https://img2020.cnblogs.com/blog/2213660/202106/2213660-20210601100458850-590171655.png ) 

选择对应的版本，复制下载地址

![image-20210601100556649](https://img2020.cnblogs.com/blog/2213660/202106/2213660-20210601100557087-330359920.png) 

然后回到虚拟机终端，安装wget服务

```bash
yum -y install wget
```

随后通过wget+刚刚的下载地址下载客户端

```bash
# wget下载会直接将软件保存到当前目录，所以可以先切换到指定目录安装
cd ~ 		# 切换到root目录
wget https://down.oray.com/hsk/linux/phddns-5.1.0.amd64.rpm
```

![image-20210601101217248](https://img2020.cnblogs.com/blog/2213660/202106/2213660-20210601101217731-586129498.png) 

如果wget下载失败，也可以直接从宿主机下载，然后进行文件传输

![image-20210601101310691](https://img2020.cnblogs.com/blog/2213660/202106/2213660-20210601101312324-2068255208.png) 

安装客户端,获得SN码，默认密码为admin

```bash
rpm -ivh phddns-5.1.0.amd64.rpm
```

![image-20210601101524304](https://img2020.cnblogs.com/blog/2213660/202106/2213660-20210601101525336-1777817408.png) 

然后进入上述管理地址 http://b.oray.com 

![image-20210601101650690](https://img2020.cnblogs.com/blog/2213660/202106/2213660-20210601101651205-2039665917.png) 

使用SN码和密码登录，然后点击小人

![image-20210601101824573](https://img2020.cnblogs.com/blog/2213660/202106/2213660-20210601101825067-36869361.png) 

使用注册的花生壳账号激活，点击提交，以后管理就是用花生壳的账号和密码登录，而不用SN

![image-20210601102003394](https://img2020.cnblogs.com/blog/2213660/202106/2213660-20210601102003841-462054916.png) 

激活成功进入管理平台

![image-20210601102103779](https://img2020.cnblogs.com/blog/2213660/202106/2213660-20210601102104204-782418906.png) 

点击免费开通

![image-20210601102156947](https://img2020.cnblogs.com/blog/2213660/202106/2213660-20210601102157360-1436723801.png) 

会获得一条映射服务

![image-20210601102232314](https://img2020.cnblogs.com/blog/2213660/202106/2213660-20210601102232728-650423094.png) 

然后进行订单提交，购买（0元），购买成功后返回花生壳管理

![image-20210601102626361](https://img2020.cnblogs.com/blog/2213660/202106/2213660-20210601102627329-1684141817.png) 

刷新页面

![image-20210601102722873](https://img2020.cnblogs.com/blog/2213660/202106/2213660-20210601102723379-2093279028.png) 

点击增加映射，出现以下页面

![image-20210601102826297](https://img2020.cnblogs.com/blog/2213660/202106/2213660-20210601102826760-1230266358.png) 

因为我们需要的是搭建网站，所以映射类型选择http

![image-20210601103156262](https://img2020.cnblogs.com/blog/2213660/202106/2213660-20210601103156645-1191511847.png) 

选择后会跳出一个http映射认证，这里需要花费6元，点击立即认证

![image-20210601103248294](https://img2020.cnblogs.com/blog/2213660/202106/2213660-20210601103248713-792740259.png) 

http认证是买一年送98年，也就是说可以用99年(某种意义上的永久)

![image-20210601103428175](https://img2020.cnblogs.com/blog/2213660/202106/2213660-20210601103428586-818086182.png) 

点击下单，然后立即购买

购买完后回到添加映射，按如下设置，点击确定

![image-20210601104102729](https://img2020.cnblogs.com/blog/2213660/202106/2213660-20210601104103717-1229690604.png) 

映射创建成功，这时选择的壳域名就是外网访问地址

![image-20210601104444155](https://img2020.cnblogs.com/blog/2213660/202106/2213660-20210601104444757-281519213.png) 

点击访问地址，即可进入我们搭建的页面

![image-20210601104518207](https://img2020.cnblogs.com/blog/2213660/202106/2213660-20210601104518638-996307409.png) 

**这时，内网穿透就完成了** 

当然，内网穿透不仅可以提供http的Web服务，还可以提供远程SSH连接服务

#### SSH远程服务映射

由于一个账号只能由一条免费的映射，所以需要再注册一个账号（一个手机号可以注册多个账号），然后按照上述步骤获得免费的映射。因为我们需要的是SSH连接服务，所以不需要进行http认证，自然SSH是免费的

点击添加映射，选择 **SSH服务** 映射模板，然后选择域名。修改内网主机，点击确定即可

![image-20210601105627672](https://img2020.cnblogs.com/blog/2213660/202106/2213660-20210601105628691-1066587477.png) 

映射创建成功

![image-20210601105733557](https://img2020.cnblogs.com/blog/2213660/202106/2213660-20210601105734068-349317699.png) 

访问地址： tcp://壳域名:端口

这时就可以通过壳域名和端口来访问该主机

